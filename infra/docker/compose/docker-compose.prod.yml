# Production Docker Compose with Traefik Reverse Proxy
# Includes both Production and Staging environments
# 
# Prerequisites:
# - DNS A/AAAA records pointing to server IP:
#   Production:
#   - <DOMAIN> -> server IP
#   - api.<DOMAIN> -> server IP
#   Staging:
#   - staging.<DOMAIN> -> server IP
#   - api-staging.<DOMAIN> -> server IP
# - Environment variables set:
#   - TRAEFIK_ACME_EMAIL (for Let's Encrypt)
#   - DOMAIN (e.g., example.com)
#   - Production secrets (JWT_SECRET, AUTH_TOKEN_PEPPER, etc.)
#   - Staging secrets (JWT_SECRET_STAGING, AUTH_TOKEN_PEPPER_STAGING, etc.)
#
# Usage:
#   # Start production only
#   docker compose -f infra/docker/compose/docker-compose.prod.yml up -d
#
#   # Start staging only (production remains running)
#   docker compose -f infra/docker/compose/docker-compose.prod.yml \
#     up -d postgres_staging redis_staging backend_staging frontend_staging
#
#   # Start everything
#   docker compose -f infra/docker/compose/docker-compose.prod.yml up -d

services:
  # Traefik Reverse Proxy (ONLY public entrypoint on ports 80/443)
  traefik:
    image: traefik:v3.0
    container_name: exam_platform_traefik
    command:
      - --configFile=/etc/traefik/traefik.yml
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../../traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - traefik_letsencrypt:/letsencrypt
      - traefik_logs:/var/log/traefik
    environment:
      - TRAEFIK_ACME_EMAIL=${TRAEFIK_ACME_EMAIL}
      - STAGING_BASIC_AUTH_USERS=${STAGING_BASIC_AUTH_USERS:-}
      - STAGING_ALLOW_IPS=${STAGING_ALLOW_IPS:-}
    networks:
      - edge
      - app
    restart: unless-stopped
    labels:
      # Reusable middlewares defined on Traefik service
      # Redirect HTTP to HTTPS
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
      
      # Security headers middleware
      - "traefik.http.middlewares.sec-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.sec-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.sec-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.sec-headers.headers.permissionsPolicy=geolocation=(), microphone=(), camera=(), payment=(), usb=(), interest-cohort=()"
      - "traefik.http.middlewares.sec-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.sec-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.sec-headers.headers.stsPreload=true"
      
      # Compression middleware
      - "traefik.http.middlewares.compress.compress=true"
      
      # Connection limit middleware (protect backend from overload)
      - "traefik.http.middlewares.conn-limit.inflightreq.amount=100"
      - "traefik.http.middlewares.conn-limit.inflightreq.sourcecriterion.ipstrategy.depth=1"
      
      # Request size limit middlewares (Buffering)
      # General API: 2MB (JSON bombs, runaway payloads)
      - "traefik.http.middlewares.req-size-limit.buffering.maxRequestBodyBytes=2000000"
      # Admin import (CSV upload): 10MB
      - "traefik.http.middlewares.req-size-limit-import.buffering.maxRequestBodyBytes=10000000"
      
      # Staging Basic Auth middleware
      # Note: If STAGING_BASIC_AUTH_USERS is empty, this middleware will not be created
      # and staging routers will fail. Always set STAGING_BASIC_AUTH_USERS when using staging.
      - "traefik.http.middlewares.staging-auth.basicauth.users=${STAGING_BASIC_AUTH_USERS}"
      - "traefik.http.middlewares.staging-auth.basicauth.removeheader=true"
      
      # Staging IP Allowlist middleware (optional)
      # Note: If STAGING_ALLOW_IPS is empty, this middleware will not be created.
      # Only set if you want IP-based allowlisting in addition to Basic Auth.
      - "traefik.http.middlewares.staging-ip.ipallowlist.sourcerange=${STAGING_ALLOW_IPS}"
      
      # Traefik Dashboard (localhost-only, accessed via SSH tunnel)
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-dashboard.rule=Host(`localhost`) || Host(`127.0.0.1`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=traefik"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"

  # PostgreSQL Database (internal only)
  postgres:
    image: postgres:15-alpine
    container_name: exam_platform_postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-exam_platform}
      POSTGRES_USER: ${POSTGRES_USER:-exam_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      # Production hardening: Tune shared_buffers (25% of memory limit)
      # For 2GB limit: shared_buffers = 512MB
      POSTGRES_SHARED_BUFFERS: ${POSTGRES_SHARED_BUFFERS:-512MB}
    # NO host port exposure - internal network only
    deploy:
      resources:
        limits:
          memory: 2g
        reservations:
          memory: 1g
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-exam_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app
    restart: unless-stopped

  # Redis Cache (internal only)
  redis:
    image: redis:7-alpine
    container_name: exam_platform_redis
    # NO host port exposure - internal network only
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - app
    restart: unless-stopped

  # Neo4j Graph Database (internal only)
  neo4j:
    image: neo4j:5-community
    container_name: exam_platform_neo4j
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD}
      NEO4J_PLUGINS: '["apoc"]'
    # NO host port exposure - internal network only
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7474"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - app
    restart: unless-stopped

  # Elasticsearch (internal only)
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:9.2.3
    container_name: exam_platform_elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    # NO host port exposure - internal network only
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - app
    restart: unless-stopped

  # FastAPI Backend (internal only, accessed via Traefik)
  backend:
    build:
      context: ../../../backend
      dockerfile: Dockerfile
    container_name: exam_platform_backend
    # NO host port exposure - accessed via Traefik only
    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 1g
        reservations:
          cpus: "0.5"
          memory: 512m
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    environment:
      - DATABASE_URL=postgresql+psycopg2://${POSTGRES_USER:-exam_user}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-exam_platform}
      - CORS_ALLOW_ORIGINS_PUBLIC=${CORS_ALLOW_ORIGINS_PUBLIC:-}
      - CORS_ALLOW_ORIGINS_APP=${CORS_ALLOW_ORIGINS_APP:-https://${DOMAIN}}
      - CORS_ALLOW_METHODS=${CORS_ALLOW_METHODS:-GET,POST,PUT,PATCH,DELETE,OPTIONS}
      - CORS_ALLOW_HEADERS=${CORS_ALLOW_HEADERS:-Authorization,Content-Type,X-Request-ID}
      - CORS_EXPOSE_HEADERS=${CORS_EXPOSE_HEADERS:-X-Request-ID,X-Response-Time-ms,X-DB-Queries,X-DB-Time-ms}
      - CORS_ALLOW_CREDENTIALS=${CORS_ALLOW_CREDENTIALS:-false}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_TTL_MIN=${JWT_ACCESS_TTL_MIN:-15}
      - JWT_REFRESH_TTL_DAYS=${JWT_REFRESH_TTL_DAYS:-14}
      - AUTH_TOKEN_PEPPER=${AUTH_TOKEN_PEPPER}
      - REDIS_URL=redis://redis:6379/0
      - NEO4J_ENABLED=${NEO4J_ENABLED:-false}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=${NEO4J_USERNAME:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=${NEO4J_DATABASE:-neo4j}
      - ELASTICSEARCH_ENABLED=${ELASTICSEARCH_ENABLED:-false}
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - ELASTICSEARCH_INDEX_PREFIX=${ELASTICSEARCH_INDEX_PREFIX:-platform}
      - ELASTICSEARCH_REQUEST_TIMEOUT_MS=${ELASTICSEARCH_REQUEST_TIMEOUT_MS:-2000}
      - ELASTICSEARCH_BULK_BATCH_SIZE=${ELASTICSEARCH_BULK_BATCH_SIZE:-500}
      - ELASTICSEARCH_RETRY_MAX=${ELASTICSEARCH_RETRY_MAX:-5}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENV=prod
      - PROJECT_NAME=${PROJECT_NAME:-Medical Exam Platform API}
      - ENABLE_HSTS=${ENABLE_HSTS:-false}  # Traefik handles HSTS at edge
      - ENABLE_CSP=${ENABLE_CSP:-false}
      # OAuth Configuration
      - OAUTH_GOOGLE_CLIENT_ID=${OAUTH_GOOGLE_CLIENT_ID:-}
      - OAUTH_GOOGLE_CLIENT_SECRET=${OAUTH_GOOGLE_CLIENT_SECRET:-}
      - OAUTH_GOOGLE_REDIRECT_URI=https://api.${DOMAIN}/v1/auth/oauth/google/callback
      - OAUTH_MICROSOFT_CLIENT_ID=${OAUTH_MICROSOFT_CLIENT_ID:-}
      - OAUTH_MICROSOFT_CLIENT_SECRET=${OAUTH_MICROSOFT_CLIENT_SECRET:-}
      - OAUTH_MICROSOFT_REDIRECT_URI=https://api.${DOMAIN}/v1/auth/oauth/microsoft/callback
      - OAUTH_MICROSOFT_TENANT=${OAUTH_MICROSOFT_TENANT:-common}
      - OAUTH_ALLOWED_REDIRECT_URIS=https://${DOMAIN},https://api.${DOMAIN}
      - FRONTEND_URL=https://${DOMAIN}
      - FRONTEND_BASE_URL=https://${DOMAIN}
      # Email Configuration
      - EMAIL_BACKEND=${EMAIL_BACKEND:-smtp}
      - EMAIL_HOST=${EMAIL_HOST}
      - EMAIL_PORT=${EMAIL_PORT:-587}
      - EMAIL_USER=${EMAIL_USER}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD}
      - EMAIL_FROM=${EMAIL_FROM}
      - EMAIL_USE_TLS=${EMAIL_USE_TLS:-true}
      - EMAIL_USE_SSL=${EMAIL_USE_SSL:-false}
      - GO_RANKING_ENABLED=${GO_RANKING_ENABLED:-false}
      - RANKING_GO_URL=http://ranking-go:8080
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - app
    restart: unless-stopped
    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"
      
      # HTTPS Router (api.<DOMAIN>)
      - "traefik.http.routers.api.rule=Host(`api.${DOMAIN}`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.api.middlewares=conn-limit@docker,req-size-limit@docker,sec-headers@docker,compress@docker"
      - "traefik.http.routers.api.priority=1"
      - "traefik.http.services.api.loadbalancer.server.port=8000"
      # Import router: POST /v1/admin/import/questions uses 10MB limit (higher priority)
      - "traefik.http.routers.api-import.rule=Host(`api.${DOMAIN}`) && PathPrefix(`/v1/admin/import/questions`) && Method(`POST`)"
      - "traefik.http.routers.api-import.entrypoints=websecure"
      - "traefik.http.routers.api-import.tls.certresolver=letsencrypt"
      - "traefik.http.routers.api-import.priority=100"
      - "traefik.http.routers.api-import.middlewares=req-size-limit-import@docker,conn-limit@docker,sec-headers@docker,compress@docker"
      - "traefik.http.routers.api-import.service=api"
      
      # HTTP Router (redirect to HTTPS)
      - "traefik.http.routers.api-http.rule=Host(`api.${DOMAIN}`)"
      - "traefik.http.routers.api-http.entrypoints=web"
      - "traefik.http.routers.api-http.middlewares=redirect-to-https@docker"

  # Next.js Frontend (internal only, accessed via Traefik)
  frontend:
    build:
      context: ../../../frontend
      dockerfile: Dockerfile
    container_name: exam_platform_frontend
    # NO host port exposure - accessed via Traefik only
    environment:
      - NEXT_PUBLIC_API_BASE_URL=https://api.${DOMAIN}/v1
      - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME:-Exam Prep Platform}
      - NEXT_PUBLIC_ENV=production
      - NEXT_PUBLIC_FEATURE_STUDENT_CONCEPT_EXPLORER=${NEXT_PUBLIC_FEATURE_STUDENT_CONCEPT_EXPLORER:-false}
      - BACKEND_URL=http://backend:8000
      - COOKIE_SECURE=true
      - COOKIE_SAMESITE=${COOKIE_SAMESITE:-lax}
      - COOKIE_DOMAIN=${DOMAIN}
      - ACCESS_COOKIE_MAXAGE_SECONDS=${ACCESS_COOKIE_MAXAGE_SECONDS:-900}
      - REFRESH_COOKIE_MAXAGE_SECONDS=${REFRESH_COOKIE_MAXAGE_SECONDS:-1209600}
      - NODE_OPTIONS=--max-old-space-size=2048
    depends_on:
      - backend
    networks:
      - app
    restart: unless-stopped
    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"
      
      # HTTPS Router (<DOMAIN>)
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.frontend.middlewares=sec-headers@docker,compress@docker"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
      
      # HTTP Router (redirect to HTTPS)
      - "traefik.http.routers.frontend-http.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.frontend-http.entrypoints=web"
      - "traefik.http.routers.frontend-http.middlewares=redirect-to-https@docker"

  # Ranking Go Service (internal only, optional)
  ranking-go:
    build:
      context: ../../../services/ranking-go
      dockerfile: Dockerfile
    container_name: exam_platform_ranking_go
    profiles:
      - ranking-go
    networks:
      - app
    restart: unless-stopped

  # ============================================
  # STAGING ENVIRONMENT (Separate from Production)
  # ============================================

  # PostgreSQL Database for Staging (separate from production)
  postgres_staging:
    image: postgres:15-alpine
    container_name: exam_platform_postgres_staging
    environment:
      POSTGRES_DB: ${POSTGRES_DB_STAGING:-exam_platform_staging}
      POSTGRES_USER: ${POSTGRES_USER_STAGING:-exam_user_staging}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD_STAGING}
      # Production hardening: Tune shared_buffers (25% of memory limit)
      POSTGRES_SHARED_BUFFERS: ${POSTGRES_SHARED_BUFFERS_STAGING:-512MB}
    # NO host port exposure - internal network only
    deploy:
      resources:
        limits:
          memory: 2g
        reservations:
          memory: 1g
    volumes:
      - postgres_staging_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER_STAGING:-exam_user_staging}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app
    restart: unless-stopped

  # Redis Cache for Staging (separate from production)
  redis_staging:
    image: redis:7-alpine
    container_name: exam_platform_redis_staging
    # NO host port exposure - internal network only
    volumes:
      - redis_staging_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - app
    restart: unless-stopped

  # FastAPI Backend Staging (internal only, accessed via Traefik)
  backend_staging:
    build:
      context: ../../../backend
      dockerfile: Dockerfile
    container_name: exam_platform_backend_staging
    # NO host port exposure - accessed via Traefik only
    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 1g
        reservations:
          cpus: "0.5"
          memory: 512m
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    environment:
      - DATABASE_URL=postgresql+psycopg2://${POSTGRES_USER_STAGING:-exam_user_staging}:${POSTGRES_PASSWORD_STAGING}@postgres_staging:5432/${POSTGRES_DB_STAGING:-exam_platform_staging}
      - CORS_ALLOW_ORIGINS_PUBLIC=${CORS_ALLOW_ORIGINS_PUBLIC_STAGING:-https://staging.${DOMAIN}}
      - CORS_ALLOW_ORIGINS_APP=${CORS_ALLOW_ORIGINS_APP_STAGING:-https://staging.${DOMAIN}}
      - CORS_ALLOW_METHODS=${CORS_ALLOW_METHODS:-GET,POST,PUT,PATCH,DELETE,OPTIONS}
      - CORS_ALLOW_HEADERS=${CORS_ALLOW_HEADERS:-Authorization,Content-Type,X-Request-ID}
      - CORS_EXPOSE_HEADERS=${CORS_EXPOSE_HEADERS:-X-Request-ID,X-Response-Time-ms,X-DB-Queries,X-DB-Time-ms}
      - CORS_ALLOW_CREDENTIALS=${CORS_ALLOW_CREDENTIALS:-false}
      - JWT_SECRET=${JWT_SECRET_STAGING}
      - JWT_ACCESS_TTL_MIN=${JWT_ACCESS_TTL_MIN:-15}
      - JWT_REFRESH_TTL_DAYS=${JWT_REFRESH_TTL_DAYS:-14}
      - AUTH_TOKEN_PEPPER=${AUTH_TOKEN_PEPPER_STAGING}
      - REDIS_URL=redis://redis_staging:6379/0
      - NEO4J_ENABLED=${NEO4J_ENABLED:-false}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=${NEO4J_USERNAME:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=${NEO4J_DATABASE:-neo4j}
      - ELASTICSEARCH_ENABLED=${ELASTICSEARCH_ENABLED:-false}
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - ELASTICSEARCH_INDEX_PREFIX=${ELASTICSEARCH_INDEX_PREFIX_STAGING:-platform_staging}
      - ELASTICSEARCH_REQUEST_TIMEOUT_MS=${ELASTICSEARCH_REQUEST_TIMEOUT_MS:-2000}
      - ELASTICSEARCH_BULK_BATCH_SIZE=${ELASTICSEARCH_BULK_BATCH_SIZE:-500}
      - ELASTICSEARCH_RETRY_MAX=${ELASTICSEARCH_RETRY_MAX:-5}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENV=staging
      - PROJECT_NAME=${PROJECT_NAME:-Medical Exam Platform API (Staging)}
      - ENABLE_HSTS=${ENABLE_HSTS:-false}  # Traefik handles HSTS at edge
      - ENABLE_CSP=${ENABLE_CSP:-false}
      # OAuth Configuration (staging)
      - OAUTH_GOOGLE_CLIENT_ID=${OAUTH_GOOGLE_CLIENT_ID_STAGING:-}
      - OAUTH_GOOGLE_CLIENT_SECRET=${OAUTH_GOOGLE_CLIENT_SECRET_STAGING:-}
      - OAUTH_GOOGLE_REDIRECT_URI=https://api-staging.${DOMAIN}/v1/auth/oauth/google/callback
      - OAUTH_MICROSOFT_CLIENT_ID=${OAUTH_MICROSOFT_CLIENT_ID_STAGING:-}
      - OAUTH_MICROSOFT_CLIENT_SECRET=${OAUTH_MICROSOFT_CLIENT_SECRET_STAGING:-}
      - OAUTH_MICROSOFT_REDIRECT_URI=https://api-staging.${DOMAIN}/v1/auth/oauth/microsoft/callback
      - OAUTH_MICROSOFT_TENANT=${OAUTH_MICROSOFT_TENANT:-common}
      - OAUTH_ALLOWED_REDIRECT_URIS=https://staging.${DOMAIN},https://api-staging.${DOMAIN}
      - FRONTEND_URL=https://staging.${DOMAIN}
      - FRONTEND_BASE_URL=https://staging.${DOMAIN}
      # Email Configuration (staging - use shadow or disabled for safety)
      - EMAIL_BACKEND=${EMAIL_BACKEND_STAGING:-shadow}
      - EMAIL_HOST=${EMAIL_HOST}
      - EMAIL_PORT=${EMAIL_PORT:-587}
      - EMAIL_USER=${EMAIL_USER}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD}
      - EMAIL_FROM=${EMAIL_FROM_STAGING:-noreply-staging@${DOMAIN}}
      - EMAIL_USE_TLS=${EMAIL_USE_TLS:-true}
      - EMAIL_USE_SSL=${EMAIL_USE_SSL:-false}
      - MFA_ENCRYPTION_KEY=${MFA_ENCRYPTION_KEY_STAGING}
      - GO_RANKING_ENABLED=${GO_RANKING_ENABLED:-false}
      - RANKING_GO_URL=http://ranking-go:8080
      # Uvicorn worker configuration (production hardening)
      - UVICORN_WORKERS=${UVICORN_WORKERS:-5}
      - UVICORN_TIMEOUT_KEEP_ALIVE=${UVICORN_TIMEOUT_KEEP_ALIVE:-5}
      - UVICORN_LIMIT_CONCURRENCY=${UVICORN_LIMIT_CONCURRENCY:-200}
      - UVICORN_LIMIT_MAX_REQUESTS=${UVICORN_LIMIT_MAX_REQUESTS:-10000}
      # Exam-time mode (disable heavy operations during exam spikes)
      - EXAM_MODE=${EXAM_MODE:-false}
      - SKIP_SEED=${SKIP_SEED:-false}
    depends_on:
      postgres_staging:
        condition: service_healthy
    networks:
      - app
    restart: unless-stopped
    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"
      
      # HTTPS Router (api-staging.<DOMAIN>)
      - "traefik.http.routers.api-staging.rule=Host(`api-staging.${DOMAIN}`)"
      - "traefik.http.routers.api-staging.entrypoints=websecure"
      - "traefik.http.routers.api-staging.tls.certresolver=letsencrypt"
      # Apply staging protection: Connection limit + Basic Auth + req-size-limit + standard middlewares
      - "traefik.http.routers.api-staging.middlewares=conn-limit@docker,req-size-limit@docker,staging-auth@docker,sec-headers@docker,compress@docker"
      - "traefik.http.routers.api-staging.priority=1"
      - "traefik.http.services.api-staging.loadbalancer.server.port=8000"
      # Import router: POST /v1/admin/import/questions uses 10MB limit (higher priority)
      - "traefik.http.routers.api-staging-import.rule=Host(`api-staging.${DOMAIN}`) && PathPrefix(`/v1/admin/import/questions`) && Method(`POST`)"
      - "traefik.http.routers.api-staging-import.entrypoints=websecure"
      - "traefik.http.routers.api-staging-import.tls.certresolver=letsencrypt"
      - "traefik.http.routers.api-staging-import.priority=100"
      - "traefik.http.routers.api-staging-import.middlewares=req-size-limit-import@docker,conn-limit@docker,staging-auth@docker,sec-headers@docker,compress@docker"
      - "traefik.http.routers.api-staging-import.service=api-staging"
      
      # HTTP Router (redirect to HTTPS)
      - "traefik.http.routers.api-staging-http.rule=Host(`api-staging.${DOMAIN}`)"
      - "traefik.http.routers.api-staging-http.entrypoints=web"
      - "traefik.http.routers.api-staging-http.middlewares=redirect-to-https@docker"

  # Next.js Frontend Staging (internal only, accessed via Traefik)
  frontend_staging:
    build:
      context: ../../../frontend
      dockerfile: Dockerfile
    container_name: exam_platform_frontend_staging
    # NO host port exposure - accessed via Traefik only
    environment:
      - NEXT_PUBLIC_API_BASE_URL=https://api-staging.${DOMAIN}/v1
      - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME_STAGING:-Exam Prep Platform (Staging)}
      - NEXT_PUBLIC_ENV=staging
      - NEXT_PUBLIC_FEATURE_STUDENT_CONCEPT_EXPLORER=${NEXT_PUBLIC_FEATURE_STUDENT_CONCEPT_EXPLORER:-false}
      - BACKEND_URL=http://backend_staging:8000
      - COOKIE_SECURE=true
      - COOKIE_SAMESITE=${COOKIE_SAMESITE:-lax}
      - COOKIE_DOMAIN=${DOMAIN}
      - ACCESS_COOKIE_MAXAGE_SECONDS=${ACCESS_COOKIE_MAXAGE_SECONDS:-900}
      - REFRESH_COOKIE_MAXAGE_SECONDS=${REFRESH_COOKIE_MAXAGE_SECONDS:-1209600}
      - NODE_OPTIONS=--max-old-space-size=2048
    depends_on:
      - backend_staging
    networks:
      - app
    restart: unless-stopped
    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"
      
      # HTTPS Router (staging.<DOMAIN>)
      - "traefik.http.routers.frontend-staging.rule=Host(`staging.${DOMAIN}`)"
      - "traefik.http.routers.frontend-staging.entrypoints=websecure"
      - "traefik.http.routers.frontend-staging.tls.certresolver=letsencrypt"
      # Apply staging protection: Basic Auth + standard middlewares
      # If STAGING_ALLOW_IPS is set, add staging-ip@docker before staging-auth@docker
      # Example with IP allowlist: staging-ip@docker,staging-auth@docker,sec-headers@docker,compress@docker
      - "traefik.http.routers.frontend-staging.middlewares=staging-auth@docker,sec-headers@docker,compress@docker"
      - "traefik.http.services.frontend-staging.loadbalancer.server.port=3000"
      
      # HTTP Router (redirect to HTTPS)
      - "traefik.http.routers.frontend-staging-http.rule=Host(`staging.${DOMAIN}`)"
      - "traefik.http.routers.frontend-staging-http.entrypoints=web"
      - "traefik.http.routers.frontend-staging-http.middlewares=redirect-to-https@docker"

# Volumes
volumes:
  postgres_data:
  redis_data:
  neo4j_data:
  neo4j_logs:
  elasticsearch_data:
  traefik_letsencrypt:
  traefik_logs:
  # Staging volumes (separate from production)
  postgres_staging_data:
  redis_staging_data:

# Networks
networks:
  edge:
    driver: bridge
    # Edge network: Only Traefik is connected (public-facing)
  app:
    driver: bridge
    # App network: All application services (backend, frontend, databases)
