name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  frontend-ci:
    name: Frontend Lint & Typecheck
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Run linter
        working-directory: frontend
        run: pnpm run lint --max-warnings=0

      - name: Check formatting
        working-directory: frontend
        run: pnpm run format:check

      - name: Run typecheck
        working-directory: frontend
        run: pnpm run typecheck

  backend-ci:
    name: Backend Lint & Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check formatting
        run: black --check .

      - name: Run linter
        run: ruff check .

      - name: Run tests
        run: pytest -v

  dependency-audit:
    name: Dependency Vulnerability Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install backend dependencies
        run: pip install -r backend/requirements.txt

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit
        run: pip-audit -f json -o backend-audit.json || true

      - name: Set FAIL_ON_HIGH
        id: set_fail_on_high
        env:
          VAR_VALUE: ${{ vars.FAIL_ON_HIGH || '0' }}
        run: |
          if [ "$VAR_VALUE" == "1" ]; then
            echo "value=1" >> $GITHUB_OUTPUT
          else
            echo "value=0" >> $GITHUB_OUTPUT
          fi

      - name: Audit check backend
        run: python scripts/audit_check_backend.py
        env:
          FAIL_ON_HIGH: ${{ steps.set_fail_on_high.outputs.value }}

      - name: Install frontend dependencies
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        working-directory: frontend
        run: pnpm audit --json > ../frontend-audit.json || true

      - name: Audit check frontend
        run: python scripts/audit_check_frontend.py
        env:
          AUDIT_JSON: frontend-audit.json

      - name: Upload audit reports
        uses: actions/upload-artifact@v4
        with:
          name: audit-reports
          path: |
            backend-audit.json
            frontend-audit.json

  docker-build:
    name: Docker Build Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: frontend
          file: frontend/Dockerfile
          tags: app-frontend:ci
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: backend
          file: backend/Dockerfile
          tags: app-backend:ci
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  backend-tests-docker:
    name: Backend Tests (Docker)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run backend tests in Docker
        working-directory: infra/docker/compose
        run: |
          docker-compose -f docker-compose.test.yml --profile test up --abort-on-container-exit --exit-code-from backend-test backend-test
        env:
          TEST_DATABASE_NAME: exam_platform_test
          TEST_DATABASE_USER: exam_user
          TEST_DATABASE_PASSWORD: test_password

      - name: Cleanup
        if: always()
        working-directory: infra/docker/compose
        run: docker-compose -f docker-compose.test.yml --profile test down -v

  frontend-tests-docker:
    name: Frontend Tests (Docker)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run frontend tests in Docker
        working-directory: infra/docker/compose
        run: |
          docker-compose -f docker-compose.test.yml --profile test up --abort-on-container-exit --exit-code-from frontend-test frontend-test
        env:
          CI: true

      - name: Cleanup
        if: always()
        working-directory: infra/docker/compose
        run: docker-compose -f docker-compose.test.yml --profile test down -v

  frontend-e2e-tests:
    name: Frontend E2E Tests (Playwright)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start backend services
        working-directory: infra/docker/compose
        run: |
          docker-compose -f docker-compose.dev.yml up -d postgres redis
        env:
          POSTGRES_DB: exam_platform
          POSTGRES_USER: exam_user
          POSTGRES_PASSWORD: exam_user_dev_pw

      - name: Start backend
        working-directory: infra/docker/compose
        run: |
          docker-compose -f docker-compose.dev.yml up -d backend
        env:
          DATABASE_URL: postgresql+psycopg2://exam_user:exam_user_dev_pw@localhost:5432/exam_platform
          REDIS_URL: redis://localhost:6379/0

      - name: Wait for backend to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:8000/v1/health; do sleep 2; done'

      - name: Seed database
        run: |
          curl -X POST http://localhost:8000/seed || true

      - name: Build frontend
        run: pnpm build

      - name: Start frontend server
        run: pnpm start &
        env:
          NEXT_PUBLIC_API_BASE_URL: http://localhost:8000/v1

      - name: Wait for frontend to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 2; done'

      - name: Run Playwright tests
        run: pnpm test:e2e
        env:
          FRONTEND_BASE_URL: http://localhost:3000
          ADMIN_USER: admin-1@example.com
          ADMIN_PASS: AdminPass123!
          STUDENT_USER: student-1@example.com
          STUDENT_PASS: StudentPass123!

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30

      - name: Upload test videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-videos
          path: frontend/test-results/
          retention-days: 7

